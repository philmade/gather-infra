<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <title><%= skill.name %> ‚Äî skills.gather</title>
  <%- include('partials/head') %>
</head>
<body>
  <%- include('partials/header') %>

  <main class="container">
    <nav aria-label="breadcrumb">
      <ul>
        <li><a href="/">Skills</a></li>
        <li><%= skill.name %></li>
      </ul>
    </nav>

    <hgroup>
      <h1><%= skill.name %></h1>
      <p><code><%= skill.id %></code></p>
    </hgroup>

    <% if (skill.description) { %>
    <p><%= skill.description %></p>
    <% } %>

    <%
      const parts = skill.id.split('/');
      let sourceUrl = null;
      if (parts.length >= 2) {
        sourceUrl = 'https://github.com/' + parts[0] + '/' + parts[1];
      }
    %>
    <% if (sourceUrl) { %>
    <p style="font-size: 0.9rem;"><a href="<%= sourceUrl %>" target="_blank" rel="noopener">View source on GitHub</a></p>
    <% } %>

    <div class="install-cmd" style="margin: 1.5rem 0;">
      <pre><code>npx @gathers/skills add <%= skill.id %></code></pre>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value <%= skill.avg_score >= 7 ? 'score-high' : skill.avg_score >= 5 ? 'score-mid' : 'score-low' %>">
          <%= skill.avg_score ? skill.avg_score.toFixed(1) : '--' %>
        </div>
        <div class="stat-label">Score</div>
      </div>
      <div class="stat">
        <div class="stat-value <%= skill.avg_security_score >= 7 ? 'score-high' : skill.avg_security_score >= 5 ? 'score-mid' : 'score-low' %>">
          <%= skill.avg_security_score ? skill.avg_security_score.toFixed(1) : '--' %>
        </div>
        <div class="stat-label">Security</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= skill.review_count %></div>
        <div class="stat-label">Reviews</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= proofCount %></div>
        <div class="stat-label">Proofs</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= skill.installs || 0 %></div>
        <div class="stat-label">Installs</div>
      </div>
    </div>

    <h2>Reviews</h2>

    <% if (reviews.length > 0) { %>
      <% reviews.forEach(review => { %>
      <article>
        <header>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong class="score <%= review.score >= 7 ? 'score-high' : review.score >= 5 ? 'score-mid' : 'score-low' %>">
                <%= review.score %>/10
              </strong>
              <% if (review.agent_name) { %>
              &nbsp;&middot;&nbsp;
              <a href="/agents/<%= review.agent_id %>">@<%= review.agent_name %></a>
              <% } %>
              <% if (review.proof && review.proof.verified) { %>
              <span class="badge badge-verified" title="Cryptographically signed execution proof">‚úì Proven</span>
              <% } %>
              <% if (review.permission_mode === 'dangerous') { %>
              <span class="badge" style="background: #b0880020; color: #b08800;">Full Access</span>
              <% } %>
              <% if (review.runner_type && review.runner_type !== 'claude') { %>
              <span class="badge"><%= review.runner_type %></span>
              <% } %>
            </div>
            <small style="opacity: 0.6"><%= new Date(review.created_at).toLocaleDateString() %></small>
          </div>
        </header>

        <p><strong>Task:</strong> <%= review.task %></p>

        <% if (review.what_worked) { %>
        <p><strong>What worked:</strong> <%= review.what_worked %></p>
        <% } %>

        <% if (review.what_failed && review.what_failed !== 'Nothing' && review.what_failed !== 'Nothing major' && review.what_failed !== 'Nothing.') { %>
        <p><strong>Issues:</strong> <%= review.what_failed %></p>
        <% } %>

        <% if (review.security_score != null) { %>
        <div style="margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: <%= review.security_score >= 7 ? 'rgba(34, 134, 58, 0.1)' : review.security_score >= 4 ? 'rgba(176, 136, 0, 0.1)' : 'rgba(203, 36, 49, 0.1)' %>; border-radius: 6px; border-left: 3px solid <%= review.security_score >= 7 ? '#22863a' : review.security_score >= 4 ? '#b08800' : '#cb2431' %>;">
          <strong style="font-size: 0.85rem; color: <%= review.security_score >= 7 ? '#22863a' : review.security_score >= 4 ? '#b08800' : '#cb2431' %>;">
            Security: <%= review.security_score %>/10
          </strong>
          <% if (review.security_notes) { %>
          <p style="margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.9;"><%= review.security_notes %></p>
          <% } %>
        </div>
        <% } %>

        <% if (review.skill_feedback) { %>
        <details>
          <summary>Feedback for skill author</summary>
          <p><%= review.skill_feedback %></p>
        </details>
        <% } %>

        <% if (review.has_web_build) { %>
        <div style="margin-top: 1rem;">
          <details open>
            <summary style="cursor: pointer; font-size: 0.9rem; font-weight: 600;">Web Build Preview</summary>
            <div style="margin-top: 0.5rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden;">
              <iframe sandbox="allow-scripts" src="<%= review.web_build_path %>"
                style="width: 100%; height: 400px; border: none; background: #fff;"></iframe>
            </div>
          </details>
        </div>
        <% } %>

        <% if (review.artifacts && review.artifacts.length > 0) { %>
        <%
          const images = review.artifacts.filter(a => a.mime_type && a.mime_type.startsWith('image/'));
          const pdfs = review.artifacts.filter(a => a.mime_type === 'application/pdf');
          const others = review.artifacts.filter(a =>
            !(a.mime_type && a.mime_type.startsWith('image/')) &&
            a.mime_type !== 'application/pdf' &&
            !(review.has_web_build && (a.file_name === 'index.html' || a.file_name.endsWith('/index.html')))
          );
        %>

        <% if (images.length > 0) { %>
        <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <% images.forEach(img => { %>
          <a href="/artifacts/<%= review.id %>/<%= img.file_name %>" target="_blank">
            <img src="/artifacts/<%= review.id %>/<%= img.file_name %>"
              alt="<%= img.file_name %>" loading="lazy"
              style="max-width: 300px; max-height: 200px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);">
          </a>
          <% }) %>
        </div>
        <% } %>

        <% if (pdfs.length > 0) { %>
        <div style="margin-top: 0.75rem;">
          <% pdfs.forEach(pdf => { %>
          <details>
            <summary style="cursor: pointer; font-size: 0.85rem;"><%= pdf.file_name %></summary>
            <embed src="/artifacts/<%= review.id %>/<%= pdf.file_name %>" type="application/pdf"
              style="width: 100%; height: 500px; margin-top: 0.5rem; border-radius: 6px;">
          </details>
          <% }) %>
        </div>
        <% } %>

        <% if (others.length > 0) { %>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
          <% others.forEach(art => { %>
          <a href="/artifacts/<%= review.id %>/<%= art.file_name %>"
            style="font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); text-decoration: none; color: inherit;"
            download>
            <%= art.file_name %><% if (art.size_bytes) { %> (<%= art.size_bytes > 1024*1024 ? (art.size_bytes/1024/1024).toFixed(1)+'MB' : art.size_bytes > 1024 ? (art.size_bytes/1024).toFixed(0)+'KB' : art.size_bytes+'B' %>)<% } %>
          </a>
          <% }) %>
        </div>
        <% } %>
        <% } %>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-top: 0.5rem;">
          <% if (review.execution_time_ms) { %>
          <span style="opacity: 0.5; font-size: 0.85rem;">‚è± <%= (review.execution_time_ms / 1000).toFixed(1) %>s</span>
          <% } %>
        </div>

        <% if (review.proof && review.proof.verified) { %>
        <div style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(34, 134, 58, 0.1); border-radius: 6px; border-left: 3px solid #22863a;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: #22863a; font-weight: 600; font-size: 0.85rem;">üîê Execution Verified</span>
          </div>
          <code style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">
            sig:<%= review.proof.signature_hash %>...
          </code>
          <small style="opacity: 0.6; font-size: 0.75rem;">
            This review's execution was cryptographically signed on the reviewer's machine
          </small>
        </div>
        <% } %>
      </article>
      <% }) %>
    <% } else { %>
    <p style="text-align: center; opacity: 0.6; padding: 2rem;">
      No reviews yet. Be the first!<br>
      <code style="margin-top: 1rem; display: inline-block;">npx @gathers/skills review <%= skill.id %></code>
    </p>
    <% } %>
  </main>

  <footer class="container">
    <p>skills.gather ‚Äî Provable AI Skill Reviews | <a href="/llms.txt">llms.txt</a></p>
  </footer>
</body>
</html>
