# Gather Platform — Local Development
# All services on one network. Ports exposed for local dev.
# Production uses docker-compose.prod.yml overrides.

services:
  # === Reverse Proxy ===

  traefik:
    image: traefik:v3.3
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # ACME via Cloudflare DNS-01 (wildcard cert for *.gather.is)
      - "--certificatesresolvers.cf.acme.dnschallenge=true"
      - "--certificatesresolvers.cf.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cf.acme.email=${ACME_EMAIL:-admin@gather.is}"
      - "--certificatesresolvers.cf.acme.storage=/acme/acme.json"
      # HTTP → HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    ports:
      - "80:80"
      - "443:443"
    environment:
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_acme:/acme
    networks:
      - gather_net

  # === Shared Infrastructure ===

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tinode:
    image: tinode/tinode-mysql:latest
    environment:
      EXT_CONFIG: /tinode.conf
      WAIT_FOR: mysql:3306
      RESET_DB: ${RESET_DB:-false}
    volumes:
      - ./shared/tinode/tinode.conf:/tinode.conf:ro
      - tinode_uploads:/uploads
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6060/v0/server/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      # Tinode WebSocket + HTTP — /v0/*
      - "traefik.http.routers.tinode.rule=Host(`gather.is`) && PathPrefix(`/v0/`)"
      - "traefik.http.routers.tinode.entrypoints=websecure"
      - "traefik.http.routers.tinode.tls.certresolver=cf"
      - "traefik.http.routers.tinode.tls.domains[0].main=gather.is"
      - "traefik.http.routers.tinode.tls.domains[0].sans=*.gather.is"
      - "traefik.http.routers.tinode.priority=10"
      - "traefik.http.services.tinode.loadbalancer.server.port=6060"

  gather-auth:
    build: ./gather-auth/go
    environment:
      JWT_SIGNING_KEY: ${JWT_SIGNING_KEY}
      POCKETBASE_ADMIN_EMAIL: ${POCKETBASE_ADMIN_EMAIL}
      POCKETBASE_ADMIN_PASSWORD: ${POCKETBASE_ADMIN_PASSWORD}
      TINODE_ADDR: tinode:16060
      TINODE_API_KEY: ${TINODE_API_KEY:-AQAAAAABAADfQzccXRHl9YIk-qQpvnkn}
      TINODE_PASSWORD_SECRET: ${TINODE_PASSWORD_SECRET:-agency_tinode_sync_v1}
      TINODE_WS_URL: ${TINODE_WS_URL:-ws://localhost:6060/v0/channels}
      BCH_ADDRESS: ${BCH_ADDRESS}
      GELATO_API_KEY: ${GELATO_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      CLAW_PROVISIONER_KEY: ${CLAW_PROVISIONER_KEY}
      CLAW_DOCKER_IMAGE: ${CLAW_DOCKER_IMAGE:-gather-claw:latest}
      CLAW_DOCKER_NETWORK: ${CLAW_DOCKER_NETWORK:-gather-infra_gather_net}
      CLAW_LLM_API_KEY: ${CLAW_LLM_API_KEY}
      CLAW_LLM_API_URL: ${CLAW_LLM_API_URL}
      CLAW_LLM_MODEL: ${CLAW_LLM_MODEL}
    volumes:
      - pocketbase_data:/pb_data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      tinode:
        condition: service_healthy
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/api/auth/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # API + docs + admin — specific paths (high priority)
      - "traefik.http.routers.auth-api.rule=Host(`gather.is`) && (PathPrefix(`/api/`) || PathPrefix(`/docs`) || PathPrefix(`/openapi`) || PathPrefix(`/schemas/`) || PathPrefix(`/help`) || PathPrefix(`/discover`) || PathPrefix(`/_/`))"
      - "traefik.http.routers.auth-api.entrypoints=websecure"
      - "traefik.http.routers.auth-api.tls.certresolver=cf"
      - "traefik.http.routers.auth-api.priority=10"
      - "traefik.http.services.auth-api.loadbalancer.server.port=8090"

  # === Frontend ===

  gather-app:
    build: ./gather-app
    depends_on:
      gather-auth:
        condition: service_healthy
    networks:
      - gather_net
    labels:
      - "traefik.enable=true"
      # Catch-all for gather.is (low priority — everything not matched above)
      - "traefik.http.routers.app.rule=Host(`gather.is`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=cf"
      - "traefik.http.routers.app.priority=1"
      - "traefik.http.services.app.loadbalancer.server.port=80"
      # Old subdomain redirects → gather.is
      - "traefik.http.routers.redirect-old.rule=Host(`app.gather.is`) || Host(`skills.gather.is`)"
      - "traefik.http.routers.redirect-old.entrypoints=websecure"
      - "traefik.http.routers.redirect-old.tls.certresolver=cf"
      - "traefik.http.routers.redirect-old.middlewares=redirect-gather"
      - "traefik.http.middlewares.redirect-gather.redirectregex.regex=^https://(app|skills)\\.gather\\.is/(.*)"
      - "traefik.http.middlewares.redirect-gather.redirectregex.replacement=https://gather.is/$${2}"
      - "traefik.http.middlewares.redirect-gather.redirectregex.permanent=true"

  # === Services ===
  # gather-chat: No longer a separate service. Tinode IS the chat server.
  # PocketNode logic (user sync, SDK registration) now lives in gather-auth.
  # The gather-chat/ directory contains the Python SDK and docs only.
  #
  # gather-skills: Ported to Go. Now runs inside gather-auth (Phase 2).
  # gather-shop: Ported to Go. Now runs inside gather-auth (Phase 2).

  gather-agents:
    # Phase 3: New PocketNode instance for agent social network
    build:
      context: ./gather-agents
      dockerfile: Dockerfile
    environment:
      TINODE_ADDR: tinode:16060
      TINODE_API_KEY: ${TINODE_API_KEY:-AQAAAAABAADfQzccXRHl9YIk-qQpvnkn}
      POCKETBASE_URL: http://gather-auth:8090
      JWT_SIGNING_KEY: ${JWT_SIGNING_KEY}
    depends_on:
      tinode:
        condition: service_healthy
      gather-auth:
        condition: service_healthy
    networks:
      - gather_net
    profiles: ["agents"]  # Not started by default until Phase 3

networks:
  gather_net:
    driver: bridge

volumes:
  mysql_data:
  tinode_uploads:
  pocketbase_data:
  traefik_acme:
