# Gather Platform — Local Development
# All services on one network. Ports exposed for local dev.
# Production uses docker-compose.prod.yml overrides.

services:
  # === Shared Infrastructure ===

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  tinode:
    image: tinode/tinode-mysql:latest
    ports:
      - "127.0.0.1:6060:6060"      # WebSocket
      - "127.0.0.1:16060:16060"    # gRPC
    environment:
      EXT_CONFIG: /tinode.conf
      WAIT_FOR: mysql:3306
      RESET_DB: ${RESET_DB:-false}
    volumes:
      - ./shared/tinode/tinode.conf:/tinode.conf:ro
      - tinode_uploads:/uploads
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6060/v0/server/status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  gather-auth:
    build: ./gather-auth/go
    ports:
      - "127.0.0.1:8090:8090"    # PocketBase + Huma API (auth, skills, shop, docs)
    environment:
      JWT_SIGNING_KEY: ${JWT_SIGNING_KEY}
      POCKETBASE_ADMIN_EMAIL: ${POCKETBASE_ADMIN_EMAIL}
      POCKETBASE_ADMIN_PASSWORD: ${POCKETBASE_ADMIN_PASSWORD}
      TINODE_ADDR: tinode:16060
      TINODE_API_KEY: ${TINODE_API_KEY:-AQAAAAABAADfQzccXRHl9YIk-qQpvnkn}
      TINODE_PASSWORD_SECRET: ${TINODE_PASSWORD_SECRET:-agency_tinode_sync_v1}
      TINODE_WS_URL: ${TINODE_WS_URL:-ws://localhost:6060/v0/channels}
      BCH_ADDRESS: ${BCH_ADDRESS}
      GELATO_API_KEY: ${GELATO_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      CLAW_PROVISIONER_KEY: ${CLAW_PROVISIONER_KEY}
      CLAW_DOCKER_IMAGE: ${CLAW_DOCKER_IMAGE:-claw-base:latest}
      CLAW_DOCKER_NETWORK: ${CLAW_DOCKER_NETWORK:-gather-infra_gather_net}
    volumes:
      - pocketbase_data:/pb_data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      tinode:
        condition: service_healthy
    networks:
      - gather_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/api/auth/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # === Frontend ===

  gather-ui:
    image: nginx:alpine
    ports:
      - "3000:80"
    volumes:
      - ./gather-ui:/usr/share/nginx/html:ro
      - ./gather-ui/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      gather-auth:
        condition: service_healthy
    networks:
      - gather_net

  # === Services ===
  # gather-chat: No longer a separate service. Tinode IS the chat server.
  # PocketNode logic (user sync, SDK registration) now lives in gather-auth.
  # The gather-chat/ directory contains the Python SDK and docs only.
  #
  # gather-skills: Ported to Go. Now runs inside gather-auth (Phase 2).
  # gather-shop: Ported to Go. Now runs inside gather-auth (Phase 2).

  gather-app:
    build: ./gather-app
    ports:
      - "127.0.0.1:3001:80"
    depends_on:
      gather-auth:
        condition: service_healthy
    networks:
      - gather_net

  gather-agents:
    # Phase 3: New PocketNode instance for agent social network
    build:
      context: ./gather-agents
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:8092:8092"
    environment:
      TINODE_ADDR: tinode:16060
      TINODE_API_KEY: ${TINODE_API_KEY:-AQAAAAABAADfQzccXRHl9YIk-qQpvnkn}
      POCKETBASE_URL: http://gather-auth:8090
      JWT_SIGNING_KEY: ${JWT_SIGNING_KEY}
    depends_on:
      tinode:
        condition: service_healthy
      gather-auth:
        condition: service_healthy
    networks:
      - gather_net
    profiles: ["agents"]  # Not started by default until Phase 3

  # nginx not included in dev compose — services accessed directly by port.
  # Production compose adds nginx for TLS + subdomain routing.

networks:
  gather_net:
    driver: bridge

volumes:
  mysql_data:
  tinode_uploads:
  pocketbase_data:
