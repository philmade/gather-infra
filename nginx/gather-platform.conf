# Gather Platform — unified nginx config (PRODUCTION)
# This is the actual config deployed to /etc/nginx/sites-enabled/gather-platform.conf
# on the production server. Uses host nginx with upstreams to Docker containers on localhost.
#
# To deploy: scp this file to server, then nginx -t && systemctl reload nginx
# Or: ssh <your-server> "cp /opt/gather-infra/nginx/gather-platform.conf /etc/nginx/sites-enabled/gather-platform.conf && nginx -t && systemctl reload nginx"

# Upstreams
upstream gather_auth {
    server 127.0.0.1:8090;
    keepalive 32;
}

upstream gather_tinode {
    server 127.0.0.1:6060;
    keepalive 32;
}

upstream gather_ui {
    server 127.0.0.1:3000;
    keepalive 32;
}

# === gather.is — Landing + API + Docs ===
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name gather.is;

    ssl_certificate /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    client_max_body_size 25M;

    # API proxy
    location /api/ {
        proxy_pass http://gather_auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # PocketBase admin — localhost only
    location /_/ {
        allow 127.0.0.1;
        deny all;
        proxy_pass http://gather_auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Swagger docs
    location /docs {
        proxy_pass http://gather_auth;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://gather_auth;
    }

    location /openapi.yaml {
        proxy_pass http://gather_auth;
    }

    location /schemas/ {
        proxy_pass http://gather_auth;
    }

    # Discovery endpoint (agents requesting JSON)
    location /discover {
        proxy_pass http://gather_auth;
        proxy_set_header Host $host;
    }

    # Help endpoint
    location /help {
        proxy_pass http://gather_auth;
    }

    # Root — content negotiation (agents get JSON, browsers get HTML)
    location = / {
        if ($http_accept ~* "application/json") {
            rewrite ^ /discover break;
            proxy_pass http://gather_auth;
        }
        proxy_pass http://gather_ui;
        proxy_set_header Host $host;
    }

    # Frontend — proxy to gather-ui container
    location / {
        proxy_pass http://gather_ui;
        proxy_set_header Host $host;
    }
}

# === app.gather.is — Chat + PocketBase API ===
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.gather.is;

    ssl_certificate /etc/letsencrypt/live/app.gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.gather.is/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    client_max_body_size 25M;

    # Tinode WebSocket
    location /v0/channels {
        proxy_pass http://gather_tinode;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Tinode HTTP
    location /v0/ {
        proxy_pass http://gather_tinode;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 600s;
    }

    # API proxy
    location /api/ {
        proxy_pass http://gather_auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # PocketBase admin — localhost only
    location /_/ {
        allow 127.0.0.1;
        deny all;
        proxy_pass http://gather_auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Docs
    location /docs {
        proxy_pass http://gather_auth;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://gather_auth;
    }

    location /help {
        proxy_pass http://gather_auth;
    }

    # Frontend
    location / {
        proxy_pass http://gather_ui;
        proxy_set_header Host $host;
    }
}

# === skills.gather.is — Skills marketplace ===
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name skills.gather.is;

    ssl_certificate /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    client_max_body_size 25M;

    location /api/ {
        proxy_pass http://gather_auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location / {
        proxy_pass http://gather_ui;
        proxy_set_header Host $host;
    }
}

# === HTTP redirects ===
server {
    listen 80;
    listen [::]:80;
    server_name gather.is app.gather.is skills.gather.is;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}
