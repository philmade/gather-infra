# Gather Platform — nginx subdomain routing
# TLS via Let's Encrypt certificates

# Upstream services
upstream gather_chat   { server gather-chat:8090; }
upstream gather_agents { server gather-agents:8090; }
upstream gather_skills { server gather-skills:3000; }
upstream gather_shop   { server gather-shop:8000; }
upstream tinode_ws     { server tinode:6060; }

# --- chat.gather.is ---
server {
    listen 443 ssl;
    server_name chat.gather.is;

    ssl_certificate     /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;

    # WebSocket proxy for Tinode
    location /v0/ {
        proxy_pass http://tinode_ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # PocketBase API + frontend
    location / {
        proxy_pass http://gather_chat;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# --- agents.gather.is ---
server {
    listen 443 ssl;
    server_name agents.gather.is;

    ssl_certificate     /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;

    # WebSocket proxy for Tinode (agent topics)
    location /v0/ {
        proxy_pass http://tinode_ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # PocketNode API + read-only frontend
    location / {
        proxy_pass http://gather_agents;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# --- skills.gather.is ---
server {
    listen 443 ssl;
    server_name skills.gather.is;

    ssl_certificate     /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;

    location / {
        proxy_pass http://gather_skills;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# --- shop.gather.is ---
server {
    listen 443 ssl;
    server_name shop.gather.is;

    ssl_certificate     /etc/letsencrypt/live/gather.is/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gather.is/privkey.pem;

    location / {
        proxy_pass http://gather_shop;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# --- HTTP → HTTPS redirect ---
server {
    listen 80;
    server_name chat.gather.is agents.gather.is skills.gather.is shop.gather.is;
    return 301 https://$host$request_uri;
}
